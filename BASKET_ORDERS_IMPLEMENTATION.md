# Basket and Orders Implementation

## Overview
This implementation adds a complete basket/cart and checkout system for the mobile app, allowing customers to add items to their basket and create orders in the Supabase database.

## Features Implemented

### 1. Basket Context (`contexts/BasketContext.tsx`)
- Global state management for basket items
- AsyncStorage persistence (basket persists across app restarts)
- Functions:
  - `addToBasket()` - Add item to basket or increment quantity
  - `removeFromBasket()` - Remove item by ID
  - `updateQuantity()` - Update item quantity
  - `clearBasket()` - Clear all items
  - `removeSelectedItems()` - Remove multiple items by IDs

### 2. Orders Library (`lib/orders.ts`)
- CRUD operations for orders and product_order tables
- Functions:
  - `createOrder()` - Create order with items (includes rollback on failure)
  - `fetchCustomerOrders()` - Get all orders for a customer
  - `updateOrderStatus()` - Update order and payment status
- Proper TypeScript types for database schema

### 3. Basket Page (`app/(tabs)/basket.tsx`)
- Display all basket items with images
- Checkbox selection for items
- Select All / Deselect All functionality
- Quantity controls (increment/decrement)
- Delete individual items
- Shows selected items count and total
- Checkout button that:
  - Creates order in Supabase
  - Removes checked items from basket
  - Shows success/error messages

### 4. Foods Page Updates (`app/(tabs)/foods.tsx`)
- Uses BasketContext instead of local state
- "Add to Basket" functionality
- Shows confirmation when item added
- Calculates points (10 points per peso)

### 5. User Type Fix (`types/auth.ts`)
- Added `profileId: number` to User type
- Auth ID (UUID string) vs Profile ID (database bigint)
- Proper foreign key reference for orders table

## Database Schema

### Orders Table
```sql
create table public.orders (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  customer_id bigint not null,
  status public.order_status not null default 'pending'::order_status,
  updated_at timestamp with time zone null,
  deleted_at timestamp with time zone null,
  cancelled_at timestamp with time zone null,
  payment_status public.payment_status not null default 'unpaid'::payment_status,
  voucher bigint null,
  discounts bigint null,
  constraint orders_pkey primary key (id),
  constraint orders_customer_id_fkey foreign KEY (customer_id) references profiles (id)
)
```

### Product_Order Table
```sql
create table public.product_order (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  order_id bigint not null,
  product_id bigint not null,
  qty integer not null,
  price double precision not null,
  updated_at timestamp with time zone null,
  deleted_at timestamp with time zone null,
  points double precision not null,
  constraint product_order_pkey primary key (id),
  constraint product_order_order_id_fkey foreign KEY (order_id) references orders (id),
  constraint product_order_product_id_fkey foreign KEY (product_id) references products (id)
)
```

## User Flow

1. **Browse Menu**
   - Customer opens Foods tab
   - Views products by category
   - Taps on item to add to basket

2. **Manage Basket**
   - Customer opens Basket tab
   - Views all items in basket
   - Can select/deselect items with checkboxes
   - Can adjust quantities
   - Can remove items

3. **Checkout**
   - Customer selects items to checkout (using checkboxes)
   - Taps "Checkout" button
   - Confirms the order
   - Order is created in Supabase with:
     - customer_id = user.profileId
     - status = 'pending'
     - payment_status = 'unpaid'
     - All selected items as product_order entries
   - Selected items are removed from local basket
   - Success message shown

## Technical Details

### AsyncStorage Keys
- `@czeus_basket` - Stores basket items as JSON array

### Points Calculation
- Formula: `points = price * 10`
- Example: ₱2.50 item = 25 points

### Order Creation
- Atomic transaction: If product_order creation fails, order is rolled back
- Default status: 'pending'
- Default payment status: 'unpaid'

### Type Safety
- User has both `id` (auth UUID) and `profileId` (database ID)
- `profileId` is used for foreign key references
- All Supabase operations properly typed

## Navigation

### Customer Role Tabs
1. Foods - Browse and add to basket
2. **Basket** - View and checkout (NEW)
3. Points - View rewards
4. Profile - User settings

## Files Modified/Created

### Created
- `mobile/czeus/contexts/BasketContext.tsx`
- `mobile/czeus/lib/orders.ts`
- `mobile/czeus/app/(tabs)/basket.tsx`
- `mobile/czeus/test/test-basket-orders.js`

### Modified
- `mobile/czeus/types/auth.ts` - Added profileId
- `mobile/czeus/lib/supabaseClient.ts` - Include profileId in auth
- `mobile/czeus/app/(tabs)/foods.tsx` - Use BasketContext
- `mobile/czeus/app/(tabs)/_layout.tsx` - Add basket tab
- `mobile/czeus/app/_layout.tsx` - Add BasketProvider
- `mobile/czeus/utils/navigation.ts` - Include basket in customer tabs

## Testing

Run the test script:
```bash
cd mobile/czeus
node test/test-basket-orders.js
```

All tests pass:
- ✓ Basket item structure
- ✓ Order creation input structure
- ✓ Total calculation
- ✓ Points calculation
- ✓ Item selection logic
- ✓ Type compatibility

## Linting

No errors, only pre-existing warnings in other files:
```bash
npm run lint
```

## Environment Setup

Required environment variables (already configured in `.env`):
```
EXPO_PUBLIC_SUPABASE_URL=https://zrzljtoctzpvrkbckthr.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=...
EXPO_PUBLIC_SUPABASE_SERVICE_ROLE_KEY=...
EXPO_PUBLIC_SUPABASE_SESSION_STORAGE_KEY=...
```

## Future Enhancements

Potential improvements:
1. Order history page for customers
2. Push notifications for order status updates
3. Payment integration
4. Apply discounts and vouchers
5. Order tracking
6. Bulk operations on basket items
7. Save for later functionality
8. Product recommendations based on basket

## Troubleshooting

### Basket not persisting
- Check AsyncStorage permissions
- Verify BasketProvider is wrapping the app

### Orders not creating
- Verify user is logged in (user.profileId exists)
- Check Supabase permissions for orders table
- Verify product IDs exist in products table

### Type errors
- Ensure latest changes to auth.ts are included
- Run `npm install` to update dependencies
- Check that profileId is being set in supabaseClient.ts
